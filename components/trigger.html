<script total>
exports.id = "trigger";
exports.name = "Trigger";
exports.group = "Triggers";
exports.version = "1";
exports.icon = "ti ti-start";
exports.author = "Total.js | Alberto Cruz";

exports.config = {
    random: true,
    type: "string",
    data: "",
    restart: false,
    prompt: false,
};

exports.outputs = [{ id: "output", name: "Output" }];
exports.kind = "trigger";

exports.make = function (instance, config) {
    const REG_PROMPT = /\{prompt\}/g;

    const getValue = (type, data, prompt) => {
        if (!config.prompt && config.random) {
            switch (type) {
                case "number": return U.random();
                case "buffer": return Buffer.from(U.random_string());
                case "date": return NOW.add(`-${U.random(500, 10)} seconds`);
                case "object": return {};
                case "boolean": return U.random() % 2 === 0;
                default: return U.random_string(20);
            }
        }

        const val = data.replace(REG_PROMPT, prompt);

        try {
            switch (type) {
                case "number": return val.parseFloat();
                case "buffer": return Buffer.from(val, "base64");
                case "date": return val.parseDate();
                case "object": return (new Function(`return ${val}`))();
                case "boolean": return /^(true|on|1)$/i.test(val);
                default: return val;
            }
        } catch (err) {
            instance.throw(err);
            return null;
        }
    };

    instance.trigger = (msg = {}) => {
        const prompt = msg.value || "";
        const value = getValue(config.type, config.data, prompt);
        instance.send("output", value);
    };

    if (config.restart)
        setTimeout(() => instance.trigger(), 5000);
};
</script>

<style>
.CLASS .padding { padding: 0 10px 10px; }

.CLASS .padding.mt20 { margin-top: 10px; }

.CLASS button {
    width: 100%;
    height: 24px;
    border: 1px solid #e0e0e0;
    border-radius: var(--radius);
    color: #000;
    background: #f0f0f0;
    margin: 0;
}

.CLASS button:hover { background: #f8f8f8; }
.CLASS button:active { background: #e0e0e0; }

.ui-dark .CLASS button {
    border-color: #404040;
    color: #fff;
    background: #222;
}

.ui-dark .CLASS button:hover { background: #303030; }
.ui-dark .CLASS button:active { background: #404040; }

.f-trigger header {
    background-color: #dad5eb;
    font-weight: bold;
    border-radius: 8px 8px 0 0;
}

.f-trigger footer {
	background-color: #dad5eb;
}

figure[data-id="trigger"] {
    background-color: #dad5eb;
    font-weight: bold;
}

</style>

<settings>
<div class="padding">
    <ui-component name="input" path="?.type"
        config="dirsource:string|String,number|Number,boolean|Boolean,date|Date,object|Object,buffer|Buffer as Base64;required:1">
        Tipo:
    </ui-component>

    <div class="mt10 m">
        <ui-component name="input" path="?.restart" config="type:checkbox">
            Enviar 5s después del RUN.
        </ui-component>

        <ui-component name="input" path="?.prompt" config="type:checkbox">
            Ventana emergente
        </ui-component>

        <ui-bind path="?.prompt" config="disabled" class="block">
            <ui-component name="input" path="?.random" config="type:checkbox">
                Datos Aleatorios
            </ui-component>
        </ui-bind>

        <ui-bind path="?.prompt" config="show" class="block hidden m mt10">
            <ui-component name="input" path="?.promptlabel" config="placeholder:Enter a value">
                <b>Título de la ventana emergente</b>
            </ui-component>
        </ui-bind>
    </div>

    <ui-bind path="?" config="hide:!value.prompt && (value.random && !value.prompt)" class="hidden">
        <hr />
        <ui-component name="input" path="?.data"
            config="required:1;height:250;type:multiline;maxlength:100000;monospace:1">
            Data
        </ui-component>
        <ui-bind path="?.prompt" config="show" class="help hidden">
            El valor de la ventana emergente será sustituido en el código por la palabra clave: <code>{prompt}</code>
        </ui-bind>
    </ui-bind>
</div>
</settings>

<readme>
El componente introduce datos en el Flujo cada vez que se pulsa RUN.
</readme>

<body>
<header><i class="$ICON"></i>$NAME</header>
<div class="padding mt20">
    <button name="run">Run</button>
</div>
<footer>
	<b>Triggers</b>
</footer>
</body>

<script>
TOUCH(exports => {
    exports.click = () => {
        if (exports.config.prompt) {
            SETTER("prompt/show", {
                name: exports.config.promptlabel || "Enter a value",
                value: "",
                callback: val => exports.trigger({ value: val }),
            });
        } else {
            exports.trigger();
        }
    };
});
</script>
