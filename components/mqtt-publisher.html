<script total>
exports.id = "mqttpublisher";
exports.name = "MQTT Publisher";
exports.icon = "ti ti-sign-out";
exports.group = "MQTT";
exports.author = "Total.js | Alberto Cruz";
exports.version = "1";
exports.flags = ["mqttclient-dep"];

exports.config = {
	client: ""
};

exports.inputs = [{ id: "message", name: "Input" }];

exports.make = function (instance, config) {
	instance.configure = function () {
		const client = instance.main.find(config.client);
		instance.status(client ? client.state.status : "Client not found");
	};

	instance.message = function ($) {
		const client = instance.main.find(config.client);
		if (!client) return $.destroy();
		client.publish($.data.topic, $.data.message, $.data.options);
		$.destroy();
	};

	instance.configure();
};

exports.call = function (data, answer) {
	const clients = this.instances().filter(i => i.module.flags?.includes("mqttclient"));
	const list = clients.map(com => ({ id: com.id, name: `${com.state.name} (${com.state.status})` }));
	answer(list);
};
</script>

<readme>
MQTT Publisher

Input:
```javascript
{
	topic: "some/topic",
	message: { "some": "data" },
	// optional
	options: {
		qos: 0|1|2,
		retain: true|false
	}
}
```
</readme>

<style>
.CLASS footer {
	padding: 10px;
	font-size: 11px;
}
.CLASS footer > ui-bind > div {
	height: 16px;
}
.CLASS footer b {
	float: right;
}

.f-mqttpublisher header {
	background-color: #cdb5cd;
	font-weight: bold;
	border-radius: 8px 8px 0 0;
}
figure[data-id="mqttpublisher"] {
	background-color: #cdb5cd;
	font-weight: bold;
}
.ui-flow .component {
	border-radius: 9px 9px 0 0;
}
.ui-flow .component-io {
	width: 14px;
	height: 14px;
}
</style>

<script>
ON("configure_mqttpublisher", function (data) {
	data.call(response => SET("%clients", response), true);
});
</script>

<settings>
<div class="padding">
	<div class="row">
		<div class="col-md-6">
			<ui-component name="input" path="?.client" config="dirsource:%clients;dirraw:1;placeholder:Select client;dirempty:No client;required:1" class="m"><b>Client</b></ui-component>
		</div>
	</div>
</div>
</settings>

<body>
<header>
	<i class="ICON"></i>NAME
</header>
<footer>
	<ui-bind path="!STATUS" config="template;show" class="block">
		<script type="text/html">
			<div><b>{{ value }}</b>Status</div>
		</script>
	</ui-bind>
</footer>
</body>
