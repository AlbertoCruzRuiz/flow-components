<script total>
exports.id = "mqttsubscriber";
exports.name = "MQTT Subscriber";
exports.icon = "ti ti-sign-in";
exports.group = "MQTT";
exports.author = "Total.js | Alberto Cruz";
exports.version = "1";
exports.flags = ["mqttclient-dep"];

exports.config = {
	client: ""
};

exports.outputs = [{ id: "message", name: "Output" }];

exports.make = function (instance, config) {
	let subscribed = false;
	let client, topic;

	instance.configure = function () {
		if (subscribed && client)
			client.unsubscribe(instance.id, topic);

		topic = config.topic;
		client = instance.main.find(config.client);

		if (client) {
			client.subscribe(instance.id, topic);
			subscribed = true;
			instance.status({ status: `${client.state.status} (subscribed)`, topic });
		} else {
			instance.status({ status: "Client not found", topic });
		}
	};

	instance.onmessage = function (topic, message, match, server_stamp) {
		instance.send("message", { topic, message, match, server_stamp });
	};

	instance.close = function () {
		if (subscribed && client)
			client.unsubscribe(instance.id, topic);
	};

	instance.configure();
};

exports.call = function (data, answer) {
	const clients = this.instances().filter(i => i.module.flags?.includes("mqttclient"));
	const list = clients.map(com => ({ id: com.id, name: `${com.state.name} (${com.state.status})` }));
	answer(list);
};
</script>

<readme>
MQTT Subscriber
</readme>

<style>
.CLASS footer { padding: 10px; font-size: 11px; }
.CLASS footer > ui-bind > div { height: 16px; }
.CLASS footer b { float: right; margin-left: 12px; }

.f-mqttsubscriber header {
	background-color: #cdb5cd;
	font-weight: bold;
	border-radius: 8px 8px 0 0;
}
figure[data-id="mqttsubscriber"] {
	background-color: #cdb5cd;
	font-weight: bold;
}
.ui-flow .component {
	border-radius: 9px 9px 0 0;
}
.ui-flow .component-io {
	width: 14px;
	height: 14px;
}
</style>

<script>
ON("configure_mqttsubscriber", function (data) {
	data.call(response => SET("%clients", response), true);
});
</script>

<settings>
<div class="padding">
	<div class="row">
		<div class="col-md-6">
			<ui-component name="input" path="?.client" config="dirsource:%clients;dirraw:1;placeholder:Select client;dirempty:No client;required:1" class="m"><b>Client</b></ui-component>
		</div>
	</div>
	<div class="row">
		<div class="col-md-6">
			<ui-component name="input" path="?.topic" config="placeholder:devices/status;required:1" class="m"><b>Topic</b></ui-component>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<p>
				<b>The topic supports wildcards like:</b><br>
				- devices/+/status -> devices/1/status or devices/123456/status etc.<br>
				- devices/#        -> any topic beginning with devices/.......
			</p>
		</div>
	</div>
</div>
</settings>

<body>
<header>
	<i class="ICON"></i>NAME
</header>
<footer>
	<ui-bind path="!STATUS" config="template;show">
		<script type="text/html">
			<div><b>{{ value.status }}</b>Status</div>
			<div><b>{{ value.topic }}</b>Topic</div>
		</script>
	</ui-bind>
</footer>
</body>
