<script total>

	exports.id = "code";
	exports.name = "Code";
	exports.group = "Data Manipulation";
	exports.version = "1";
	exports.icon = "ti ti-code";
	exports.author = "Total.js | Alberto Cruz";
	exports.config = {
		outputs: 1,
		name: "Code",
		code: `// # Input data #
// data types: {String/Number/Boolean/Date/Buffer/Object};
// let variable_1 = data;
// let variable_2 = data.message;

// # Output data #
//send(data);
// OR
//send(output_number, data);

// send(1, variable_2);
`
	};

	exports.inputs = [{ id: "input", name: "Input: data" }];
	exports.outputs = [{ id: "output", name: "Output 1: output_1" }];
	exports.meta = {
		settingswidth: 1200,
		display: true
	};

	exports.make = function(instance, config) {

		let fn = null;

		instance.message = function($) {
			if (!fn)
				return;

			let handled = false;

			// Hook into send() and throw() to track usage
			const originalSend = $.send;
			const originalThrow = $.throw;

			$.send = function() {
				handled = true;
				return originalSend.apply($, arguments);
			};

			$.throw = function() {
				handled = true;
				return originalThrow.apply($, arguments);
			};

			try {
				const send = function(a, b) {
					if (arguments.length === 1) {
						$.send("output", a);
					} else if (typeof a === "number") {
						const id = "output" + (a === 1 ? "" : a);
						$.send(id, b);
					} else {
						$.send(a, b);
					}
				};

				fn($.data, instance, $, $, F.require, send, $.repo, $.vars, $.data);
			} catch (err) {
				$.throw(err);
			}

			if (!handled)
				$.destroy();
		};

		instance.configure = function() {
			instance.outputs = Array.from({ length: config.outputs }, (_, i) => ({
				id: "output" + (i === 0 ? "" : i + 1),
				name: "Output " + (i + 1) + ": output_" + (i + 1)
			}));
			instance.save();

			try {
				if (config.code) {
					instance.status(1);
					fn = new Function("value", "instance", "$", "message", "require", "send", "repo", "vars", "data", config.code);
				} else {
					instance.status(0);
					fn = null;
				}
			} catch (err) {
				fn = null;
				instance.throw("Code: " + err.message);
			}
		};

		instance.close = () => fn = null;

		instance.configure();
	};

</script>

<readme>
This component executes custom JavaScript dynamically.

You can send output using:
- `send(data)` → sends to first output (`output_1`)
- `send(3, data)` → sends to `output_3`
- `$.send("output2", data)` → traditional style
- `$.throw(error)` → sends error
- `$.destroy()` is called automatically if nothing is sent or thrown
</readme>

<settings>
	<div class="padding">
		<div class="row">
			<div class="col-md-10 m">
				<ui-component name="input" path="?.name">Name</ui-component>
			</div>
			<div class="col-md-2 m">
				<ui-component name="input" path="?.outputs" config="type:number;format:">Number of outputs</ui-component>
			</div>
		</div>
		<div class="ui-input-label">Code:</div>
		<div class="m">
			<ui-component name="codemirror" path="?.code" config="type:javascript;minheight:300;parent:auto;margin:60;tabs:true;trim:true"></ui-component>
		</div>
	</div>
</settings>

<script>
	TOUCH(function(exports) {
		exports.configure = function() {
			const changes = exports.instance.changes;
			if (changes?.newbie) {
				const count = exports.instance.config.outputs;
				exports.instance.outputs = Array.from({ length: count }, (_, i) => ({
					id: "output" + (i === 0 ? "" : i + 1),
					name: "Output " + (i + 1) + ": output_" + (i + 1)
				}));
				UPD("flow.data");
			}
		};
	});
</script>

<body>
	<header>
		<i class="ICON"></i>NAME
	</header>
</body>

<style>
.f-code header {
	background-color: #f0c59a;
	font-weight: bold;
	border-radius: 8px 8px 0 0;
}
figure[data-id="code"] {
	background-color: #f0c59a;
	font-weight: bold;
}
.ui-flow .component {
	border-radius: 9px 9px 0 0;
}
.ui-flow .component-io {
	width: 14px;
	height: 14px;
}
</style>
