<script total>
exports.id = "printjson";
exports.name = "Print JSON";
exports.group = "Data Logger";
exports.version = "1";
exports.icon = "ti ti-print";
exports.author = "Total.js | Alberto Cruz";

exports.config = {
	repo: false,
	data: true
};

exports.inputs = [{ id: "input", name: "Input" }];

exports.make = function (instance, config) {
	instance.message = function ($) {
		let data = $.data;

		if (config.data !== false && data instanceof Buffer)
			data = data.toString("hex").substring(0, 200);

		let count = Object.values(config).filter(Boolean).length;
		let output = count > 1 ? {} : null;

		if (config.repo)
			output ? output.repo = $.repo : output = $.repository;

		if (config.data)
			output ? output.data = $.data : output = $.data;

		if (output)
			instance.status(output, 200);

		$.destroy();
	};

	instance.trigger = () => instance.status("");
};
</script>

<style>
.CLASS footer > ui-component { margin: 10px; }

.CLASS pre {
	font-size: 10px;
	margin: 0;
	padding: 5px;
	background-color: #f0f0f0;
	border-radius: var(--radius);
}

.CLASS button {
	float: right;
	height: 20px;
	font-size: 11px;
	border: 1px solid #e0e0e0;
	border-radius: var(--radius);
	color: #000;
	background-color: transparent;
	margin: 0;
	padding: 0 5px;
}

.CLASS button:hover { background-color: #f8f8f8; }
.CLASS button:active { background-color: #e0e0e0; }
.CLASS .ui-objecttree {
	background-color: #f0f0f0;
	padding: 4px;
}

.ui-dark .CLASS pre { background-color: #404040; tab-size: 2; }
.ui-dark .CLASS button { border-color: #404040; color: #fff; }
.ui-dark .CLASS button:hover { background-color: #303030; }
.ui-dark .CLASS button:active { background-color: #404040; }

.f-printjson header {
	background-color: #80a07a;
	font-weight: bold;
	border-radius: 8px 8px 0 0;
}

figure[data-id="printjson"] {
	background-color: #80a07a;
	font-weight: bold;
}

.ui-flow .component {
	border-radius: 9px 9px 0 0;
}

.ui-flow .component-io {
	width: 14px;
	height: 14px;
}
</style>

<settings>
<div class="padding">
	<ui-component name="input" path="?.repo" config="type:checkbox">
		Shows repository
	</ui-component>
	<ui-component name="input" path="?.data" config="type:checkbox">
		Shows data
	</ui-component>
</div>
</settings>

<readme>
El componente imprime los datos entrantes en formato JSON.
</readme>

<body>
<header>
	<button class="exec" data-exec="FUNC.trigger">Clear</button>
	<i class="ICON"></i>NAME
</header>
<footer>
	<ui-component name="objecttree" path="!STATUS" config="exec:FUNC.printjson_click" class="selectable"></ui-component>
</footer>
</body>

<script>
FUNC.printjson_click = function (type, data) {
	navigator.clipboard.writeText(type === "path" ? data : STRINGIFY(data))
		.catch(console.error);
};

$("body").on("click", ".ui-objecttree .ti-copy, .ui-objecttree .ti-link", function () {
	const el = $(this);
	const isCopy = el.hclass("ti-copy");
	el.tclass(isCopy ? "ti-copy" : "ti-link").tclass("ti-check");
	setTimeout(() => {
		el.tclass("ti-check").tclass(isCopy ? "ti-copy" : "ti-link");
	}, 2000);
});
</script>
